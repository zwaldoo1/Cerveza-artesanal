---
import BaseLayout from "../layout/BaseLayout.astro";
---

<BaseLayout title="Carrito — CervezaArtesana" description="Tu carrito de compras">
  <section class="flex flex-col md:flex-row items-start justify-between gap-8">
    <div class="flex-1">
      <div class="mb-4 flex items-center justify-between">
        <h1 class="text-2xl font-bold">Carrito</h1>
        <button id="btn-vaciar" class="text-sm rounded-md border px-3 py-1.5 hover:bg-slate-50">
          Vaciar carrito
        </button>
      </div>

      <div id="cart-empty" class="rounded-lg border p-6 text-center hidden">
        <p class="mb-4 text-slate-600">Tu carrito está vacío.</p>
        <a href="/catalogo" class="inline-block rounded-md bg-brand px-4 py-2 font-medium text-white hover:bg-brand-dark">
          Ir al catálogo
        </a>
      </div>

      <div id="cart-list" class="space-y-3"></div>
    </div>

    <aside class="w-full max-w-sm rounded-lg border p-4 sticky top-6 self-start">
      <h2 class="mb-3 font-semibold">Resumen</h2>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">$0</span></div>
        <div class="flex justify-between"><span>Envío</span><span id="envio">A calcular</span></div>
        <div class class="flex justify-between font-semibold border-t pt-2"><span>Total</span><span id="total">$0</span></div>
      </div>
      <button id="btn-pagar" class="mt-4 w-full rounded-md bg-brand px-4 py-2 font-medium text-white hover:bg-brand-dark">
        Ir a pagar
      </button>
      <p class="mt-2 text-xs text-slate-500">Podrás revisar tus datos antes de pagar.</p>
    </aside>
  </section>

  <!-- Import ESTÁTICO con extensión .ts -->
  <script type="module">
    import { useCart } from "../lib/cart.ts";

    const listEl = document.getElementById("cart-list");
    const emptyEl = document.getElementById("cart-empty");
    const subtotalEl = document.getElementById("subtotal");
    const totalEl = document.getElementById("total");
    const btnPagar = document.getElementById("btn-pagar");
    const btnVaciar = document.getElementById("btn-vaciar");

    const fmt = (n) => "$" + (n ?? 0).toLocaleString("es-CL");

    function render() {
      const st = useCart.getState();
      const items = st.items;
      const tot = st.total();

      if (!items.length) {
        emptyEl.classList.remove("hidden");
        listEl.innerHTML = "";
        subtotalEl.textContent = fmt(0);
        totalEl.textContent = fmt(0);
        btnPagar.setAttribute("disabled", "true");
        btnPagar.classList.add("opacity-60", "cursor-not-allowed");
        return;
      }

      emptyEl.classList.add("hidden");
      btnPagar.removeAttribute("disabled");
      btnPagar.classList.remove("opacity-60", "cursor-not-allowed");

      let html = "";
      for (const i of items) {
        html += `
          <div class="rounded-md border p-3 flex items-center gap-4" data-id="${i.id}">
            <img src="${i.image ?? "/images/placeholder.jpg"}" alt="${i.name}" class="h-16 w-16 rounded-md object-cover" />
            <div class="flex-1">
              <p class="font-medium">${i.name}</p>
              <div class="mt-1 flex items-center gap-2 text-sm">
                <button class="btn-minus rounded-md border px-2 py-1 hover:bg-slate-50" aria-label="Disminuir">−</button>
                <span class="qty min-w-6 text-center">${i.qty}</span>
                <button class="btn-plus rounded-md border px-2 py-1 hover:bg-slate-50" aria-label="Aumentar">+</button>
                <button class="btn-remove ml-3 text-slate-500 hover:text-red-600" aria-label="Eliminar">Eliminar</button>
              </div>
            </div>
            <div class="text-right">
              <div class="font-semibold">${fmt(i.price * i.qty)}</div>
              <div class="text-xs text-slate-500">${fmt(i.price)} c/u</div>
            </div>
          </div>
        `;
      }
      listEl.innerHTML = html;

      subtotalEl.textContent = fmt(tot);
      totalEl.textContent = fmt(tot);
    }

    listEl.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      const row = target.closest("[data-id]");
      if (!row) return;

      const id = row.getAttribute("data-id");
      if (!id) return;

      const st = useCart.getState();
      const item = st.items.find((x) => x.id === id);

      if (target.classList.contains("btn-plus")) {
        st.setQty(id, (item?.qty ?? 0) + 1);
      } else if (target.classList.contains("btn-minus")) {
        st.setQty(id, (item?.qty ?? 0) - 1);
      } else if (target.classList.contains("btn-remove")) {
        st.remove(id);
      }
    });

    btnVaciar?.addEventListener("click", () => {
      if (confirm("¿Vaciar todo el carrito?")) {
        useCart.getState().clear();
      }
    });

    btnPagar?.addEventListener("click", () => {
      const items = useCart.getState().items;
      if (!items.length) return;
      window.location.href = "/checkout";
    });

    render();
    window.addEventListener("cart:updated", render);
  </script>
</BaseLayout>
